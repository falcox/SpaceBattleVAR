#ifndef LASER_BEAM
#define LASER_BEAM

#define LASER_SPEED			1200
//#define LASER_SPEED		0

class LaserBeam{
	var object;
	var lightIndex;
	//var lightFactory;
	var initPos;
	var actualPos;
	var finalPos;
	var shootTime;
	var collision;
	var direction;
	var posThreshold;
	var lastCalled;
	var damage;
	
	//LaserBeam(mesh, lights, lightIdx, begin, end, originTime, dmg);
	LaserBeam(mesh, lightIdx, begin, end, originTime, dmg);
	rotateToDirection(dir);
	setCollided();
	setRotationMatrix(matrix);
	isCollidingBBox(obj);
	getObject();
	getDamage();
	getLightIndex();
	update();
	draw();
};

function LaserBeam::LaserBeam(mesh, /*lights,*/ lightIdx, begin, end, originTime, dmg){
	object = CVmObj(mesh);
	initPos = begin;
	actualPos = begin;
	finalPos = end;
	shootTime = originTime;
	direction = finalPos-initPos;
	posThreshold = modulus(direction);
	direction = direction / posThreshold; 
	collision = false;
	LastCalled = 0;
	outputln("new bullet!");
	damage = dmg;
	//LightFactory = lights;
	LightIndex = lightIdx;
}

function LaserBeam::setRotationMatrix(matrix){
	object.setRotationMatrix(matrix);
}

function LaserBeam::rotateToDirection(dir){
	var r = object.getXaxis();
	var u = dir ^ r;
	r = r / modulus(r);
	object.setRotationMatrix([r.x, r.y, r.z, 0, u.x, u.y, u.z, 0, dir.x, dir.y, dir.z, 0, 0, 0, 0, 1]);
}

function LaserBeam::setCollided(){
	collision = true;
}

function LaserBeam::update(){
	//static var time = GetTime();
	if(LastCalled == 0){
		lastCalled = GetTime();
	}
	var time = lastCalled;
	var killMe = false;
	var timeTickSecond = 0.001;
	var displacement;
	//time -= shootTime;

	timeTickSecond *= (GetTime() - time);
	//outputln(sprintf("time :%f, timeTickSecond: %f", time, timeTickSecond));
	
	/*---settaggio direzione e posizione--- */
	this.rotateToDirection(direction);
	displacement = direction*timeTickSecond*LASER_SPEED;
	//displacement = [0,0,0];
	actualPos += displacement;
	object.SetPosition(actualPos);
	//lightFactory.setLightPosition(lightIndex, actualPos);
	//trace(timeTickSecond);
		
	/*--- check se distruggere il proiettile ---*/
	if(modulus(actualPos - initPos) > posThreshold || collision == true){
		killMe = true;
		//lightFactory.releaseLight(lightIndex);
		outputln("bullet needs to be killed");
	}
	
	lastCalled = GetTime();
	return killMe;
}

function LaserBeam::isCollidingBBox(obj){
	return object.isCollidingBBox(obj);
}

function LaserBeam::draw(){   
	object.draw();
#ifdef DEBUGGING
	object.drawAxis();
#endif
}

function LaserBeam::getDamage(){
	return damage;
}

function LaserBeam::getObject(){
	return object;
}

function LaserBeam::getLightIndex(){
	return lightIndex;
}

#endif
